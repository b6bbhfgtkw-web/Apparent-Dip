<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Apparent Dip Calculator</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0B3D91" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <style>
    :root{
      --bg:#0b1220; --card:#111b2e; --text:#e9eefc; --muted:#b9c4e3;
      --accent:#4da3ff; --accent2:#7ee787; --danger:#ff6b6b; --warn:#ffd166;
      --radius:16px; --shadow: 0 10px 30px rgba(0,0,0,.35);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, system-ui, sans-serif;
    }
    body{ margin:0; background: radial-gradient(1200px 800px at 20% 0%, #162a55 0%, var(--bg) 55%);
          color:var(--text); min-height:100vh; display:flex; justify-content:center; }
    .wrap{ width:min(920px, 100%); padding:20px 16px 44px; }
    header{ padding:10px 6px 18px; }
    h1{ margin:0; font-size: clamp(22px, 4vw, 34px); letter-spacing:.2px; }
    .sub{ color:var(--muted); margin-top:8px; line-height:1.35; }

    .card{ background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
           border: 1px solid rgba(255,255,255,.10); border-radius: var(--radius);
           box-shadow: var(--shadow); padding: 16px; }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin: 8px 0 4px; }
    .tab{ padding:10px 12px; border-radius: 12px; border:1px solid rgba(255,255,255,.12);
          background: rgba(10,16,30,.55); color: var(--text); cursor:pointer; font-weight:800; }
    .tab[aria-selected="true"]{ background: rgba(77,163,255,.22); border-color: rgba(77,163,255,.55); }

    .twoCol{ display:grid; grid-template-columns: 1fr; gap:12px; }
    @media(min-width: 840px){ .twoCol{ grid-template-columns: 1fr 1fr; } }

    .grid{ display:grid; grid-template-columns: 1fr; gap:12px; }
    @media(min-width: 840px){ .grid{ grid-template-columns: 1fr 1fr 1fr; } }

    label{ display:block; font-size: 13px; color: var(--muted); margin: 0 0 6px; }
    input{ width:100%; padding:12px 12px; border-radius: 12px;
           border: 1px solid rgba(255,255,255,.15);
           background: rgba(10,16,30,.65); color: var(--text);
           font-size: 16px; outline: none; box-sizing:border-box; }
    input:focus{ border-color: rgba(77,163,255,.8); box-shadow: 0 0 0 4px rgba(77,163,255,.15); }

    .rangeWrap{ display:grid; grid-template-columns: 1fr 120px; gap:10px; align-items:center; }
    input[type="range"]{ width:100%; accent-color: var(--accent); }

    .row{ display:flex; gap:10px; margin-top:14px; flex-wrap:wrap; }
    button{ border:0; border-radius: 12px; padding:12px 14px; font-size: 16px; font-weight: 900;
            background: var(--accent); color:#07101f; cursor:pointer; }
    button.secondary{ background: rgba(255,255,255,.10); color: var(--text); font-weight:800; }
    button:active{ transform: translateY(1px); }

    .result{ margin-top: 14px; padding: 14px; border-radius: 14px;
             background: rgba(0,0,0,.20); border:1px solid rgba(255,255,255,.10);
             display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    .big{ font-size: clamp(28px, 6vw, 46px); font-weight: 950; letter-spacing:.3px; }
    .small{ color: var(--muted); line-height:1.35; }
    .pill{ display:inline-block; padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight:900;
           background: rgba(126,231,135,.15); color: var(--accent2); border:1px solid rgba(126,231,135,.25); }

    .error{ margin-top: 10px; color: var(--danger); font-weight: 800; }
    .warn{ margin-top: 10px; color: var(--warn); font-weight: 800; }

    details{ margin-top: 14px; }
    summary{ cursor:pointer; color: var(--muted); }

    .foot{ margin-top: 18px; color: var(--muted); font-size: 12px; line-height:1.45; }
    .foot code{ background: rgba(255,255,255,.08); padding: 2px 6px; border-radius: 8px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .hint{ font-size: 12px; color: var(--muted); margin-top: 6px; }

    .kpi{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .kpi > div{ padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04); }
    .kpi .label{ font-size: 12px; color: var(--muted); }
    .kpi .value{ font-weight: 900; font-size: 15px; }

    .sectionTitle{ margin-top: 6px; font-weight: 900; letter-spacing:.2px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Apparent Dip Calculator</h1>
      <div class="sub">
        Compute apparent dip from a plane’s true dip and strike.
        Choose plane input style (<b>Azimuth (RHR)</b> or <b>Quadrant + dip direction</b>) and choose section input style (<b>Bearing</b> or measured <b>θ</b>).
      </div>
    </header>

    <main class="card">

      <div class="twoCol">
        <div>
          <div class="sectionTitle">1) Section / observation direction input</div>
          <div class="tabs" role="tablist" aria-label="Section input style">
            <button class="tab" id="tab-bear" role="tab" aria-selected="true" aria-controls="panel-bear" type="button">By bearing</button>
            <button class="tab" id="tab-theta" role="tab" aria-selected="false" aria-controls="panel-theta" type="button">By θ (angle)</button>
          </div>

          <!-- Bearing panel -->
          <div id="panel-bear" role="tabpanel" aria-labelledby="tab-bear" style="margin-top:10px;">
            <label for="bearingNum">Bearing / section direction (azimuth, 0–360°)</label>
            <div class="rangeWrap">
              <input id="bearingRange" type="range" min="0" max="360" step="1" value="120" />
              <input id="bearingNum" inputmode="decimal" type="number" min="0" max="360" step="0.1" value="120" />
            </div>
            <div class="hint">Use this if you know the trend of your cross section / line of observation.</div>
          </div>

          <!-- Theta panel -->
          <div id="panel-theta" role="tabpanel" aria-labelledby="tab-theta" style="margin-top:10px; display:none;">
            <label for="thetaNum">θ = angle between strike and apparent dip direction (0–90°)</label>
            <div class="rangeWrap">
              <input id="thetaRange" type="range" min="0" max="90" step="1" value="53" />
              <input id="thetaNum" inputmode="decimal" type="number" min="0" max="90" step="0.1" value="53" />
            </div>
            <div class="hint">Use this if you measured θ directly in map view (acute angle between strike line and section direction).</div>
          </div>
        </div>

        <div>
          <div class="sectionTitle">2) Plane input style</div>
          <div class="tabs" role="tablist" aria-label="Plane input style">
            <button class="tab" id="tab-az" role="tab" aria-selected="true" aria-controls="panel-az" type="button">Azimuth (RHR)</button>
            <button class="tab" id="tab-quad" role="tab" aria-selected="false" aria-controls="panel-quad" type="button">Quadrant + dip dir</button>
          </div>
          <div class="hint">Students can use either convention. Sliders + keyed inputs are provided for numeric variables.</div>
        </div>
      </div>

      <!-- Azimuth (RHR) panel -->
      <div id="panel-az" role="tabpanel" aria-labelledby="tab-az" style="margin-top:12px;">
        <div class="grid">
          <div>
            <label for="strikeAzNum">Strike azimuth (RHR, 0–360°)</label>
            <div class="rangeWrap">
              <input id="strikeAzRange" type="range" min="0" max="360" step="1" value="0" />
              <input id="strikeAzNum" inputmode="decimal" type="number" min="0" max="360" step="0.1" value="0" />
            </div>
            <div class="hint">Right‑hand rule: dip direction is 90° clockwise from strike.</div>
          </div>
          <div>
            <label for="dipAzNum">True dip (0–90°)</label>
            <div class="rangeWrap">
              <input id="dipAzRange" type="range" min="0" max="90" step="1" value="30" />
              <input id="dipAzNum" inputmode="decimal" type="number" min="0" max="90" step="0.1" value="30" />
            </div>
          </div>
          <div>
            <label>Derived dip direction (azimuth)</label>
            <input id="dipDirDerived" type="text" class="mono" value="—" readonly />
            <div class="hint">Computed as strike + 90° (mod 360).</div>
          </div>
        </div>
      </div>

      <!-- Quadrant panel -->
      <div id="panel-quad" role="tabpanel" aria-labelledby="tab-quad" style="margin-top:12px; display:none;">
        <div class="grid">
          <div>
            <label for="strikeQuad">Strike (quadrant)</label>
            <input id="strikeQuad" type="text" placeholder="e.g., N67E" />
            <div class="hint">Examples: <span class="mono">N67E</span>, <span class="mono">S12W</span>, <span class="mono">NE</span>, <span class="mono">270</span></div>
          </div>
          <div>
            <label for="dipQuadNum">True dip (0–90°)</label>
            <div class="rangeWrap">
              <input id="dipQuadRange" type="range" min="0" max="90" step="1" value="30" />
              <input id="dipQuadNum" inputmode="decimal" type="number" min="0" max="90" step="0.1" value="30" />
            </div>
          </div>
          <div>
            <label for="dipDirQuad">Dip direction (quadrant or azimuth)</label>
            <input id="dipDirQuad" type="text" placeholder="e.g., SE or S23E or 135" />
            <div class="hint">Used for validation only (should be ~perpendicular to strike).</div>
          </div>
        </div>

        <div class="kpi" aria-live="polite">
          <div><div class="label">Parsed strike azimuth</div><div class="value mono" id="parsedStrike">—</div></div>
          <div><div class="label">Parsed dip direction azimuth</div><div class="value mono" id="parsedDipDir">—</div></div>
          <div><div class="label">Consistency check</div><div class="value" id="consistency">—</div></div>
        </div>
      </div>

      <div id="err" class="error" style="display:none"></div>
      <div id="warn" class="warn" style="display:none"></div>

      <div class="row">
        <button id="calc">Calculate</button>
        <button class="secondary" id="clear" type="button">Clear</button>
      </div>

      <div class="result" aria-live="polite">
        <div>
          <div class="pill">Result</div>
          <div class="big" id="out">—</div>
          <div class="small" id="meta">Enter values and tap Calculate.</div>
        </div>
      </div>

      <details>
        <summary>Show formula + notes</summary>
        <div class="foot">
          Uses: <code>tan(α) = tan(δ) × sin(θ)</code>, where <code>δ</code> is true dip, <code>α</code> is apparent dip,
          and <code>θ</code> is the acute angle (0–90°) between the strike line and the observation direction.
          You can supply <code>θ</code> directly or let the app compute it from strike + bearing.
        </div>
      </details>

      <div class="foot">
        Local/offline tip: keep this folder in the iPhone <b>Files</b> app and open <code>index.html</code>.
      </div>
    </main>
  </div>

<script>
  // ---------- Helpers ----------
  function norm360(x){ let v = x % 360; if(v < 0) v += 360; return v; }
  function clamp(x, lo, hi){ return Math.min(Math.max(x, lo), hi); }
  function deg2rad(d){ return d * Math.PI / 180; }
  function rad2deg(r){ return r * 180 / Math.PI; }

  // Acute angle (0–90) between strike line and bearing line
  function acuteAngleBetweenStrikeAndBearing(strike, bearing){
    const s = norm360(strike);
    const b = norm360(bearing);
    let diff = Math.abs(b - s);
    if(diff > 180) diff = 360 - diff; // 0–180
    if(diff > 90) diff = 180 - diff;  // 0–90
    return diff;
  }

  // Apparent dip from true dip and theta
  function apparentFromTheta(trueDip, thetaDeg){
    const dip = clamp(trueDip, 0, 90);
    const theta = clamp(thetaDeg, 0, 90);
    if(dip >= 89.999) return 90.0;
    const tanApp = Math.tan(deg2rad(dip)) * Math.sin(deg2rad(theta));
    const app = rad2deg(Math.atan(tanApp));
    return clamp(app, 0, dip);
  }

  // ---------- Quadrant parsing ----------
  // Accepts numeric azimuth, N/E/S/W, NE/NW/SE/SW, or N67E / S12W etc.
  function parseAzOrQuadrant(raw){
    if(raw === null || raw === undefined) return { ok:false, err:'Empty' };
    const s0 = String(raw).trim();
    if(!s0) return { ok:false, err:'Empty' };

    // numeric?
    const num = Number(s0);
    if(!Number.isNaN(num) && /[-+0-9.]/.test(s0) && !/[NSEW]/i.test(s0)){
      return { ok:true, az:norm360(num), canonical: norm360(num).toFixed(3) + '°' };
    }

    const s = s0.toUpperCase().replace(/\s+/g,'');
    const ord = { 'N':0, 'E':90, 'S':180, 'W':270, 'NE':45, 'SE':135, 'SW':225, 'NW':315 };
    if(ord[s] !== undefined){
      return { ok:true, az: ord[s], canonical: s };
    }

    const m = s.match(/^([NS])(\d+(?:\.\d+)?)([EW])$/);
    if(!m) return { ok:false, err:'Use e.g., N67E, S12W, NE, or an azimuth number.' };

    const ns = m[1];
    const ang = Number(m[2]);
    const ew = m[3];
    if(Number.isNaN(ang)) return { ok:false, err:'Angle not recognized.' };
    if(ang < 0 || ang > 90) return { ok:false, err:'Quadrant angle must be 0–90.' };

    let az;
    if(ns === 'N' && ew === 'E') az = ang;
    if(ns === 'N' && ew === 'W') az = 360 - ang;
    if(ns === 'S' && ew === 'E') az = 180 - ang;
    if(ns === 'S' && ew === 'W') az = 180 + ang;
    return { ok:true, az:norm360(az), canonical: `${ns}${ang}${ew}` };
  }

  function dipDirConsistency(strikeAz, dipDirAz){
    const a = norm360(strikeAz + 90);
    const b = norm360(strikeAz - 90);
    const d1 = Math.min(Math.abs(norm360(dipDirAz - a)), Math.abs(norm360(a - dipDirAz)));
    const d2 = Math.min(Math.abs(norm360(dipDirAz - b)), Math.abs(norm360(b - dipDirAz)));
    return Math.min(d1, d2);
  }

  // ---------- Slider+Number sync ----------
  function bindRangeNumber(rangeEl, numberEl, onAnyChange){
    const min = Number(rangeEl.min), max = Number(rangeEl.max);
    function syncFromRange(){
      numberEl.value = rangeEl.value;
      if(onAnyChange) onAnyChange();
    }
    function syncFromNumber(){
      let v = Number(numberEl.value);
      if(Number.isNaN(v)) return;
      v = clamp(v, min, max);
      numberEl.value = v;
      rangeEl.value = v;
      if(onAnyChange) onAnyChange();
    }
    rangeEl.addEventListener('input', syncFromRange);
    numberEl.addEventListener('input', syncFromNumber);
    // initialize
    syncFromRange();
  }

  // ---------- UI Elements ----------
  const tabBear = document.getElementById('tab-bear');
  const tabTheta = document.getElementById('tab-theta');
  const panelBear = document.getElementById('panel-bear');
  const panelTheta = document.getElementById('panel-theta');

  const tabAz = document.getElementById('tab-az');
  const tabQuad = document.getElementById('tab-quad');
  const panelAz = document.getElementById('panel-az');
  const panelQuad = document.getElementById('panel-quad');

  const bearingRange = document.getElementById('bearingRange');
  const bearingNum = document.getElementById('bearingNum');
  const thetaRange = document.getElementById('thetaRange');
  const thetaNum = document.getElementById('thetaNum');

  const strikeAzRange = document.getElementById('strikeAzRange');
  const strikeAzNum = document.getElementById('strikeAzNum');
  const dipAzRange = document.getElementById('dipAzRange');
  const dipAzNum = document.getElementById('dipAzNum');
  const dipDirDerived = document.getElementById('dipDirDerived');

  const strikeQuad = document.getElementById('strikeQuad');
  const dipQuadRange = document.getElementById('dipQuadRange');
  const dipQuadNum = document.getElementById('dipQuadNum');
  const dipDirQuad = document.getElementById('dipDirQuad');

  const parsedStrikeEl = document.getElementById('parsedStrike');
  const parsedDipDirEl = document.getElementById('parsedDipDir');
  const consistencyEl = document.getElementById('consistency');

  const outEl = document.getElementById('out');
  const metaEl = document.getElementById('meta');
  const errEl = document.getElementById('err');
  const warnEl = document.getElementById('warn');

  let planeMode = 'az';      // 'az' or 'quad'
  let sectionMode = 'bear';  // 'bear' or 'theta'

  function showError(msg){ errEl.textContent = msg; errEl.style.display = msg ? 'block':'none'; }
  function showWarn(msg){ warnEl.textContent = msg; warnEl.style.display = msg ? 'block':'none'; }
  function clearMessages(){ showError(''); showWarn(''); }

  function setSectionMode(next){
    sectionMode = next;
    const bearOn = (sectionMode === 'bear');
    tabBear.setAttribute('aria-selected', bearOn ? 'true':'false');
    tabTheta.setAttribute('aria-selected', bearOn ? 'false':'true');
    panelBear.style.display = bearOn ? 'block':'none';
    panelTheta.style.display = bearOn ? 'none':'block';
    clearMessages();
  }

  function setPlaneMode(next){
    planeMode = next;
    const azOn = (planeMode === 'az');
    tabAz.setAttribute('aria-selected', azOn ? 'true':'false');
    tabQuad.setAttribute('aria-selected', azOn ? 'false':'true');
    panelAz.style.display = azOn ? 'block':'none';
    panelQuad.style.display = azOn ? 'none':'block';
    clearMessages();
    updateDerivedDipDir();
    updateQuadrantParsed();
  }

  tabBear.addEventListener('click', ()=>setSectionMode('bear'));
  tabTheta.addEventListener('click', ()=>setSectionMode('theta'));
  tabAz.addEventListener('click', ()=>setPlaneMode('az'));
  tabQuad.addEventListener('click', ()=>setPlaneMode('quad'));

  function updateDerivedDipDir(){
    const strike = Number(strikeAzNum.value);
    if(Number.isNaN(strike)) { dipDirDerived.value = '—'; return; }
    dipDirDerived.value = norm360(strike + 90).toFixed(1) + '°';
  }

  function updateQuadrantParsed(){
    if(planeMode !== 'quad') return;
    const ps = parseAzOrQuadrant(strikeQuad.value);
    const pd = parseAzOrQuadrant(dipDirQuad.value);
    parsedStrikeEl.textContent = ps.ok ? (ps.az.toFixed(1) + '°') : '—';
    parsedDipDirEl.textContent = pd.ok ? (pd.az.toFixed(1) + '°') : '—';

    if(ps.ok && pd.ok){
      const delta = dipDirConsistency(ps.az, pd.az);
      if(delta <= 1){ consistencyEl.textContent = 'OK'; consistencyEl.style.color = 'var(--accent2)'; }
      else if(delta <= 5){ consistencyEl.textContent = `Close (off by ${delta.toFixed(1)}°)`; consistencyEl.style.color = 'var(--warn)'; }
      else { consistencyEl.textContent = `Check (off by ${delta.toFixed(1)}°)`; consistencyEl.style.color = 'var(--danger)'; }
    } else {
      consistencyEl.textContent = '—';
      consistencyEl.style.color = 'var(--muted)';
    }
  }

  strikeQuad.addEventListener('input', updateQuadrantParsed);
  dipDirQuad.addEventListener('input', updateQuadrantParsed);

  function getTheta(strikeAz){
    if(sectionMode === 'theta'){
      const t = Number(thetaNum.value);
      if(Number.isNaN(t)) return { ok:false, err:'Please enter a numeric θ (0–90°).' };
      return { ok:true, theta: clamp(t,0,90), source:`θ (input) = ${clamp(t,0,90).toFixed(3)}°` };
    } else {
      const b = Number(bearingNum.value);
      if(Number.isNaN(b)) return { ok:false, err:'Please enter a numeric bearing (0–360°).' };
      const theta = acuteAngleBetweenStrikeAndBearing(strikeAz, b);
      return { ok:true, theta, source:`θ (from bearing) = ${theta.toFixed(3)}°` };
    }
  }

  function calculate(){
    clearMessages();

    let strikeAz, dip;

    if(planeMode === 'az'){
      strikeAz = Number(strikeAzNum.value);
      dip = Number(dipAzNum.value);
      if([strikeAz, dip].some(v => Number.isNaN(v))){ showError('Please enter numeric strike and dip in Azimuth mode.'); return; }
      if(dip < 0 || dip > 90){ showError('True dip must be 0–90°'); return; }
      updateDerivedDipDir();
    } else {
      const ps = parseAzOrQuadrant(strikeQuad.value);
      dip = Number(dipQuadNum.value);
      if(!ps.ok){ showError('Strike: ' + ps.err); return; }
      if(Number.isNaN(dip) || dip < 0 || dip > 90){ showError('True dip must be 0–90°'); return; }
      strikeAz = ps.az;
      updateQuadrantParsed();
      const pd = parseAzOrQuadrant(dipDirQuad.value);
      if(pd.ok){
        const delta = dipDirConsistency(strikeAz, pd.az);
        if(delta > 5){ showWarn(`Dip direction looks inconsistent with strike (off by ${delta.toFixed(1)}° from perpendicular). Check inputs.`); }
      } else if(String(dipDirQuad.value).trim().length){
        showWarn('Dip direction not recognized — calculation will still work, but validation is skipped.');
      }
    }

    const thetaInfo = getTheta(strikeAz);
    if(!thetaInfo.ok){ showError(thetaInfo.err); return; }

    const app = apparentFromTheta(dip, thetaInfo.theta);
    outEl.textContent = app.toFixed(3) + '°';

    let extra;
    if(sectionMode === 'bear'){
      extra = `Bearing = ${Number(bearingNum.value).toFixed(3)}°; ${thetaInfo.source}`;
    } else {
      extra = thetaInfo.source;
    }
    metaEl.textContent = extra;
  }

  document.getElementById('calc').addEventListener('click', calculate);

  document.getElementById('clear').addEventListener('click', ()=>{
    // section
    bearingRange.value = 120; bearingNum.value = 120;
    thetaRange.value = 53; thetaNum.value = 53;

    // plane az
    strikeAzRange.value = 0; strikeAzNum.value = 0;
    dipAzRange.value = 30; dipAzNum.value = 30;
    dipDirDerived.value = '—';

    // plane quad
    strikeQuad.value = '';
    dipQuadRange.value = 30; dipQuadNum.value = 30;
    dipDirQuad.value = '';
    parsedStrikeEl.textContent = '—';
    parsedDipDirEl.textContent = '—';
    consistencyEl.textContent = '—';
    consistencyEl.style.color = 'var(--muted)';

    outEl.textContent = '—';
    metaEl.textContent = 'Enter values and tap Calculate.';
    clearMessages();
  });

  // Bind sliders
  bindRangeNumber(bearingRange, bearingNum, null);
  bindRangeNumber(thetaRange, thetaNum, null);
  bindRangeNumber(strikeAzRange, strikeAzNum, updateDerivedDipDir);
  bindRangeNumber(dipAzRange, dipAzNum, null);
  bindRangeNumber(dipQuadRange, dipQuadNum, null);

  // Init
  setSectionMode('bear');
  setPlaneMode('az');
  updateDerivedDipDir();

  // Optional service worker (mainly relevant when hosted)
  if('serviceWorker' in navigator){
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(() => {});
    });
  }
</script>
</body>
</html>
